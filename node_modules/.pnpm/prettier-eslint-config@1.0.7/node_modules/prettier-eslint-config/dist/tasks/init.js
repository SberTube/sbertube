"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const utils_1 = require("../utils");
const fs_jetpack_1 = tslib_1.__importDefault(require("fs-jetpack"));
const path_1 = tslib_1.__importDefault(require("path"));
const child_process_1 = tslib_1.__importDefault(require("child_process"));
const ora_1 = tslib_1.__importDefault(require("ora"));
const merge_1 = require("../utils/merge");
/**
 * cliåˆå§‹åŒ–æ–¹æ³•
 * @description æä¾›ç»™ç”¨æˆ·é€‰æ‹©æ¨¡æ¿ç±»å‹ï¼Œç›®å‰æä¾›jså’Œtsæ¨¡æ¿
 */
const init = async () => {
    // const describe = ' è¯·é€‰æ‹©é¡¹ç›®æ¨¡æ¿';
    // const list = ['js', 'ts'];
    // const answer = await createPrompt(describe, list);
    createEslintrc();
    createPrettierrc();
    // switch (answer) {
    // 	case list[0]:
    // 		// TODO
    // 		createEslintrc();
    // 		createPrettierrc();
    // 		break;
    // 	case list[1]:
    // 		// TODO
    // 		createEslintrc();
    // 		createPrettierrc();
    // 		break;
    // 	default:
    // 		logger.error('âŒè¯·é€‰æ‹©å¯¹åº”çš„é¡¹ç›®æ¨¡æ¿');
    // 		break;
    // }
    utils_1.logger.success('ğŸ‰ é…ç½®å®Œæˆï¼');
    installDependencies();
};
// æ¨¡æ¿æ–‡ä»¶çš„è·¯å¾„
const templatePath = path_1.default.resolve(__dirname, '../../templates');
/**
 * åˆ›å»ºeslintè§„åˆ™æ–‡ä»¶
 */
const createEslintrc = () => {
    const cwd_path = process.cwd();
    const has_eslintrc = fs_jetpack_1.default.find(cwd_path, { matching: ['./.eslintrc.*'] });
    // æ–‡ä»¶å
    const filename = '.eslintrc.js';
    // ä¸å­˜åœ¨å·²æœ‰eslinté…ç½®
    if (has_eslintrc.length === 0) {
        utils_1.logger.primary('ğŸ„ğŸ» åˆ›å»ºeslintæ–‡ä»¶...');
        // ä»æ¨¡æ¿ä¸­å¤åˆ¶åˆ°é¡¹ç›®ç›®å½•ä¸­
        fs_jetpack_1.default.copy(path_1.default.resolve(templatePath, filename), path_1.default.resolve(cwd_path, filename));
    }
    else {
        // å·²æœ‰ç›¸å…³eslinté…ç½®
        utils_1.logger.warning('â—ï¸å·²æœ‰eslintç›¸å…³é…ç½®æ–‡ä»¶ï¼Œæ˜¯å¦åˆ é™¤å·²æœ‰é…ç½®');
        // TODO: è¿›è¡Œé…ç½®åˆå¹¶
    }
};
/**
 * åˆ›å»ºprettierè§„åˆ™æ–‡ä»¶
 */
const createPrettierrc = () => {
    const cwd_path = process.cwd();
    const has_prettierrc = fs_jetpack_1.default.find(cwd_path, { matching: ['./.prettierrc.*'] });
    const filename = '.prettierrc.js';
    if (has_prettierrc.length === 0) {
        utils_1.logger.primary('ğŸ„ğŸ» åˆ›å»ºprettieræ–‡ä»¶...');
        // ä»æ¨¡æ¿ä¸­å¤åˆ¶åˆ°é¡¹ç›®ç›®å½•ä¸­
        try {
            fs_jetpack_1.default.copy(path_1.default.resolve(templatePath, filename), path_1.default.resolve(cwd_path, filename));
        }
        catch (error) {
            utils_1.logger.error(`âŒ é…ç½®å¤±è´¥ ${error}`);
        }
    }
    else {
        // å·²æœ‰ç›¸å…³eslinté…ç½®
        utils_1.logger.warning('â—ï¸å·²æœ‰prettierç›¸å…³é…ç½®æ–‡ä»¶ï¼Œå³å°†è¿›è¡Œæ–‡ä»¶åˆå¹¶');
        // JSæ–‡ä»¶åˆå¹¶
        (0, merge_1.mergeJSFile)(has_prettierrc[0]);
    }
};
/**
 * å®‰è£…æ‰€éœ€è¦çš„ä¾èµ–
 */
const installDependencies = async () => {
    utils_1.logger.primary('ä¾èµ–æ³¨å…¥ä¸­...');
    // æ–°å¢ä¾èµ–
    const devDependencies = {
        eslint: '^7.32.0',
        prettier: '^2.3.2',
        '@typescript-eslint/parser': '^4.30.0',
        '@typescript-eslint/eslint-plugin': '^2.31.0',
        'eslint-config-prettier': '^6.11.0',
        'eslint-plugin-prettier': '^3.1.3',
    };
    const package_path = path_1.default.resolve(fs_jetpack_1.default.cwd(), 'package.json');
    const package_file = fs_jetpack_1.default.exists(package_path);
    // æ–‡ä»¶ä¸å­˜åœ¨
    if (!package_file) {
        // æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤
        await child_process_1.default.exec('npm init -y');
    }
    const content = fs_jetpack_1.default.read(package_path, 'json');
    // åˆå¹¶é…ç½®
    content.devDependencies = Object.assign(Object.assign({}, content.devDependencies), devDependencies);
    await fs_jetpack_1.default.writeAsync(package_path, content);
    utils_1.logger.success('ä¾èµ–æ³¨å…¥æˆåŠŸï¼');
    // é€‰æ‹©å®‰è£…ä¾èµ–çš„å·¥å…·
    const describe = ' è¯·é€‰æ‹©æ‚¨ä¿¡èµ–çš„ä¾èµ–å®‰è£…å·¥å…·';
    const list = ['npm', 'yarn', 'è¾¾å’©:)'];
    const answer = await (0, utils_1.createPrompt)(describe, list);
    // ç”¨æˆ·é€‰æ‹©æ‰‹åŠ¨å®‰è£…
    if (answer === list[2]) {
        utils_1.logger.warning('ä¸ºäº†ç¡®ä¿æ’ä»¶ç”Ÿæ•ˆï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ npm i æˆ–è€… yarn å®‰è£…æ–°å¢çš„ä¾èµ–');
        return;
    }
    const loading = (0, ora_1.default)('ğŸ˜„ ä¾èµ–å®‰è£…ä¸­ï¼Œå¯ä»¥æ‰“ä¸ªå“ˆæ¬ ä¼‘æ¯ä¸€ä¸‹').start();
    try {
        const prefix = answer === list[0] ? 'npm install' : 'yarn add';
        let res = `${prefix} `;
        for (let key in devDependencies) {
            res += `${key}@${devDependencies[key]} `;
        }
        child_process_1.default.exec(res, (error, stdout) => {
            if (error !== null) {
                console.log('exec error: ' + error);
            }
            utils_1.logger.primary(`\r\n${stdout}`);
            loading.stop();
            loading.succeed('ä¾èµ–å®‰è£…æˆåŠŸï¼Œå°½æƒ…ä½¿ç”¨å§~');
        });
    }
    catch (err) {
        utils_1.logger.error(err.message);
    }
};
exports.default = init;
